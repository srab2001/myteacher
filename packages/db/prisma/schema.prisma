generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AppUser {
  id                  String                 @id @default(uuid())
  googleId            String?                @unique
  username            String?                @unique
  passwordHash        String?
  email               String                 @unique
  displayName         String
  avatarUrl           String?
  role                UserRole?
  stateCode           String?
  districtName        String?
  schoolName          String?
  isOnboarded         Boolean                @default(false)
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  jurisdictionId      String?
  jurisdiction        Jurisdiction?          @relation(fields: [jurisdictionId], references: [id])
  bestPracticeUploads BestPracticeDocument[] @relation("BestPracticeUploadedBy")
  formTemplateUploads FormTemplate[]         @relation("FormTemplateUploadedBy")
  progressRecords     GoalProgress[]         @relation("ProgressRecordedBy")
  priorPlanUploads    PriorPlanDocument[]    @relation("PriorPlanUploadedBy")
  serviceLogs         ServiceLog[]           @relation("ServiceProvider")
  students            Student[]              @relation("TeacherStudents")
  statusUpdates       StudentStatus[]        @relation("StatusUpdatedBy")
  workSamples         WorkSample[]           @relation("WorkSampleUploadedBy")

  @@index([googleId])
  @@index([email])
  @@index([username])
}

model Jurisdiction {
  id               String                 @id @default(uuid())
  stateCode        String
  stateName        String
  districtCode     String
  districtName     String
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  users            AppUser[]
  bestPracticeDocs BestPracticeDocument[] @relation("BestPracticeJurisdiction")
  formTemplates    FormTemplate[]         @relation("FormTemplateJurisdiction")
  planTypes        PlanType[]
  students         Student[]

  @@unique([stateCode, districtCode])
  @@index([stateCode])
}

model Student {
  id                 String              @id @default(uuid())
  firstName          String
  lastName           String
  dateOfBirth        DateTime
  grade              String
  schoolName         String
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  jurisdictionId     String
  teacherId          String
  externalId         String?
  recordId           String              @unique
  planInstances      PlanInstance[]
  priorPlanDocuments PriorPlanDocument[]
  jurisdiction       Jurisdiction        @relation(fields: [jurisdictionId], references: [id])
  teacher            AppUser             @relation("TeacherStudents", fields: [teacherId], references: [id])
  statuses           StudentStatus[]

  @@index([recordId])
  @@index([externalId])
  @@index([lastName, firstName])
  @@index([teacherId])
}

model StudentStatus {
  id            String      @id @default(uuid())
  scope         StatusScope
  code          StatusCode
  summary       String?
  effectiveDate DateTime
  createdAt     DateTime    @default(now())
  studentId     String
  updatedById   String
  student       Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  updatedBy     AppUser     @relation("StatusUpdatedBy", fields: [updatedById], references: [id])

  @@index([studentId, scope])
  @@index([studentId, effectiveDate])
}

model PlanType {
  id                 String                 @id @default(uuid())
  code               PlanTypeCode
  name               String
  description        String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  jurisdictionId     String
  bestPracticeDocs   BestPracticeDocument[] @relation("BestPracticeDocs")
  formTemplates      FormTemplate[]         @relation("FormTemplates")
  instances          PlanInstance[]
  schemas            PlanSchema[]
  jurisdiction       Jurisdiction           @relation(fields: [jurisdictionId], references: [id])
  priorPlanDocuments PriorPlanDocument[]

  @@unique([jurisdictionId, code])
  @@index([code])
}

model PlanSchema {
  id            String         @id @default(uuid())
  version       Int            @default(1)
  name          String
  description   String?
  fields        Json
  isActive      Boolean        @default(true)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  planTypeId    String
  instances     PlanInstance[]
  planType      PlanType       @relation(fields: [planTypeId], references: [id])

  @@index([planTypeId, isActive])
}

model PlanInstance {
  id          String           @id @default(uuid())
  startDate   DateTime
  endDate     DateTime?
  status      String           @default("DRAFT")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  studentId   String
  planTypeId  String
  schemaId    String
  goals       Goal[]
  fieldValues PlanFieldValue[]
  planType    PlanType         @relation(fields: [planTypeId], references: [id])
  schema      PlanSchema       @relation(fields: [schemaId], references: [id])
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  serviceLogs ServiceLog[]

  @@index([studentId, planTypeId])
  @@index([status])
}

model PlanFieldValue {
  id             String       @id @default(uuid())
  fieldKey       String
  value          Json
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  planInstanceId String
  planInstance   PlanInstance @relation(fields: [planInstanceId], references: [id], onDelete: Cascade)

  @@unique([planInstanceId, fieldKey])
  @@index([planInstanceId])
}

model Goal {
  id                  String         @id @default(uuid())
  goalCode            String
  area                GoalArea
  baselineJson        Json?
  annualGoalText      String
  shortTermObjectives Json?
  progressSchedule    String?
  targetDate          DateTime?
  isActive            Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  planInstanceId      String
  planInstance        PlanInstance   @relation(fields: [planInstanceId], references: [id], onDelete: Cascade)
  progressRecords     GoalProgress[]
  workSamples         WorkSample[]

  @@unique([planInstanceId, goalCode])
  @@index([planInstanceId])
  @@index([area])
}

model GoalProgress {
  id           String        @id @default(uuid())
  date         DateTime      @default(now())
  quickSelect  ProgressLevel
  measureJson  Json?
  comment      String?
  isDictated   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  goalId       String
  recordedById String
  goal         Goal          @relation(fields: [goalId], references: [id], onDelete: Cascade)
  recordedBy   AppUser       @relation("ProgressRecordedBy", fields: [recordedById], references: [id])

  @@index([goalId, date])
  @@index([goalId])
}

model WorkSample {
  id           String           @id @default(uuid())
  fileUrl      String
  fileName     String
  fileType     String
  fileSize     Int
  rating       WorkSampleRating
  comment      String?
  capturedAt   DateTime         @default(now())
  createdAt    DateTime         @default(now())
  goalId       String
  uploadedById String
  goal         Goal             @relation(fields: [goalId], references: [id], onDelete: Cascade)
  uploadedBy   AppUser          @relation("WorkSampleUploadedBy", fields: [uploadedById], references: [id])

  @@index([goalId])
  @@index([capturedAt])
}

model ServiceLog {
  id             String         @id @default(uuid())
  date           DateTime
  minutes        Int
  serviceType    ServiceType
  setting        ServiceSetting
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  planInstanceId String
  providerId     String
  planInstance   PlanInstance   @relation(fields: [planInstanceId], references: [id], onDelete: Cascade)
  provider       AppUser        @relation("ServiceProvider", fields: [providerId], references: [id])

  @@index([planInstanceId, date])
  @@index([planInstanceId, serviceType])
  @@index([providerId])
}

model PriorPlanDocument {
  id           String          @id @default(uuid())
  fileName     String
  storageKey   String
  planDate     DateTime?
  source       PriorPlanSource @default(UPLOADED)
  notes        String?
  createdAt    DateTime        @default(now())
  studentId    String
  planTypeId   String
  uploadedById String
  planType     PlanType        @relation(fields: [planTypeId], references: [id])
  student      Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  uploadedBy   AppUser         @relation("PriorPlanUploadedBy", fields: [uploadedById], references: [id])

  @@index([studentId])
  @@index([studentId, planTypeId])
  @@index([uploadedById])
}

model BestPracticeDocument {
  id               String              @id @default(uuid())
  title            String
  description      String?
  fileUrl          String
  gradeBand        String?
  isActive         Boolean             @default(true)
  ingestionStatus  IngestionStatus     @default(PENDING)
  ingestionMessage String?
  ingestionAt      DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  planTypeId       String
  jurisdictionId   String?
  uploadedById     String
  chunks           BestPracticeChunk[]
  jurisdiction     Jurisdiction?       @relation("BestPracticeJurisdiction", fields: [jurisdictionId], references: [id])
  planType         PlanType            @relation("BestPracticeDocs", fields: [planTypeId], references: [id])
  uploadedBy       AppUser             @relation("BestPracticeUploadedBy", fields: [uploadedById], references: [id])

  @@index([planTypeId])
  @@index([jurisdictionId])
  @@index([isActive])
  @@index([ingestionStatus])
}

model FormTemplate {
  id             String        @id @default(uuid())
  title          String
  description    String?
  fileUrl        String
  isDefault      Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  planTypeId     String
  jurisdictionId String?
  uploadedById   String
  jurisdiction   Jurisdiction? @relation("FormTemplateJurisdiction", fields: [jurisdictionId], references: [id])
  planType       PlanType      @relation("FormTemplates", fields: [planTypeId], references: [id])
  uploadedBy     AppUser       @relation("FormTemplateUploadedBy", fields: [uploadedById], references: [id])

  @@index([planTypeId])
  @@index([jurisdictionId])
  @@index([planTypeId, jurisdictionId, isDefault])
}

model BestPracticeChunk {
  id                     String               @id @default(uuid())
  sequence               Int
  sectionTag             String?
  text                   String
  embedding              Bytes?
  createdAt              DateTime             @default(now())
  planTypeCode           String
  jurisdictionId         String?
  gradeBand              String?
  bestPracticeDocumentId String
  document               BestPracticeDocument @relation(fields: [bestPracticeDocumentId], references: [id], onDelete: Cascade)

  @@index([bestPracticeDocumentId])
  @@index([planTypeCode, jurisdictionId, gradeBand, sectionTag])
  @@index([sectionTag])
}

model session {
  sid    String   @id @db.VarChar
  sess   Json     @db.Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], map: "IDX_session_expire")
}

enum UserRole {
  TEACHER
  CASE_MANAGER
  ADMIN
}

enum PlanTypeCode {
  IEP
  FIVE_OH_FOUR
  BEHAVIOR_PLAN
}

enum StatusScope {
  OVERALL
  ACADEMIC
  BEHAVIOR
  SERVICES
}

enum StatusCode {
  ON_TRACK
  WATCH
  CONCERN
  URGENT
}

enum GoalArea {
  READING
  WRITING
  MATH
  COMMUNICATION
  SOCIAL_EMOTIONAL
  BEHAVIOR
  MOTOR_SKILLS
  DAILY_LIVING
  VOCATIONAL
  OTHER
}

enum ProgressLevel {
  NOT_ADDRESSED
  FULL_SUPPORT
  SOME_SUPPORT
  LOW_SUPPORT
  MET_TARGET
}

enum WorkSampleRating {
  BELOW_TARGET
  NEAR_TARGET
  MEETS_TARGET
  ABOVE_TARGET
}

enum ServiceType {
  SPECIAL_EDUCATION
  SPEECH_LANGUAGE
  OCCUPATIONAL_THERAPY
  PHYSICAL_THERAPY
  COUNSELING
  BEHAVIORAL_SUPPORT
  READING_SPECIALIST
  PARAPROFESSIONAL
  OTHER
}

enum ServiceSetting {
  GENERAL_EDUCATION
  SPECIAL_EDUCATION
  RESOURCE_ROOM
  THERAPY_ROOM
  COMMUNITY
  HOME
  OTHER
}

enum PriorPlanSource {
  UPLOADED
  SIS_IMPORT
}

enum IngestionStatus {
  PENDING
  PROCESSING
  COMPLETE
  ERROR
}
