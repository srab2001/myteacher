// Prisma schema for MyTeacher - Special Education Portal
// Database: PostgreSQL

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  output        = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  TEACHER
  CASE_MANAGER
  ADMIN
}

enum PlanTypeCode {
  IEP
  FIVE_OH_FOUR // 504 Plan
  BEHAVIOR_PLAN
}

enum StatusScope {
  OVERALL
  ACADEMIC
  BEHAVIOR
  SERVICES
}

enum StatusCode {
  ON_TRACK
  WATCH
  CONCERN
  URGENT
}

enum GoalArea {
  READING
  WRITING
  MATH
  COMMUNICATION
  SOCIAL_EMOTIONAL
  BEHAVIOR
  MOTOR_SKILLS
  DAILY_LIVING
  VOCATIONAL
  OTHER
}

enum ProgressLevel {
  NOT_ADDRESSED
  FULL_SUPPORT
  SOME_SUPPORT
  LOW_SUPPORT
  MET_TARGET
}

enum WorkSampleRating {
  BELOW_TARGET
  NEAR_TARGET
  MEETS_TARGET
  ABOVE_TARGET
}

enum ServiceType {
  SPECIAL_EDUCATION
  SPEECH_LANGUAGE
  OCCUPATIONAL_THERAPY
  PHYSICAL_THERAPY
  COUNSELING
  BEHAVIORAL_SUPPORT
  READING_SPECIALIST
  PARAPROFESSIONAL
  OTHER
}

enum ServiceSetting {
  GENERAL_EDUCATION
  SPECIAL_EDUCATION
  RESOURCE_ROOM
  THERAPY_ROOM
  COMMUNITY
  HOME
  OTHER
}

enum PriorPlanSource {
  UPLOADED
  SIS_IMPORT
}

enum IngestionStatus {
  PENDING
  PROCESSING
  COMPLETE
  ERROR
}

enum BehaviorMeasurementType {
  FREQUENCY
  DURATION
  INTERVAL
  RATING
}

// ============================================
// USER MODEL
// ============================================

model AppUser {
  id            String    @id @default(uuid())
  googleId      String?   @unique  // Optional for local auth users
  username      String?   @unique  // For local auth
  passwordHash  String?            // For local auth (bcrypt hashed)
  email         String    @unique
  displayName   String
  avatarUrl     String?
  role          UserRole?
  stateCode     String?
  districtName  String?
  schoolName    String?
  isOnboarded   Boolean   @default(false)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  jurisdictionId String?
  jurisdiction   Jurisdiction? @relation(fields: [jurisdictionId], references: [id])
  students       Student[]     @relation("TeacherStudents")
  statusUpdates  StudentStatus[] @relation("StatusUpdatedBy")
  progressRecords GoalProgress[] @relation("ProgressRecordedBy")
  workSamples    WorkSample[]   @relation("WorkSampleUploadedBy")
  serviceLogs    ServiceLog[]   @relation("ServiceProvider")
  iepAssessmentReviews IEPIndependentAssessmentReview[] @relation("AssessmentReviewCreator")
  priorPlanUploads PriorPlanDocument[] @relation("PriorPlanUploadedBy")
  bestPracticeUploads BestPracticeDocument[] @relation("BestPracticeUploadedBy")
  formTemplateUploads FormTemplate[] @relation("FormTemplateUploadedBy")
  behaviorEvents BehaviorEvent[] @relation("BehaviorRecordedBy")
  permission     UserPermission?
  studentAccess  StudentAccess[]
  artifactComparisons ArtifactComparison[] @relation("ArtifactComparisonCreatedBy")
    authCodes           AuthCode[]           @relation("AuthCodeUser")


  @@index([googleId])
  @@index([email])
  @@index([username])
  createdStudentFieldValues StudentFieldValue[] @relation("StudentFieldValueCreator")
}

// ============================================
// JURISDICTION MODEL
// ============================================

model Jurisdiction {
  id           String   @id @default(uuid())
  stateCode    String
  stateName    String
  districtCode String
  districtName String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  users     AppUser[]
  planTypes PlanType[]
  students  Student[]
  planSchemas      PlanSchema[]           @relation("PlanSchemaJurisdiction")
  bestPracticeDocs BestPracticeDocument[] @relation("BestPracticeJurisdiction")
  formTemplates    FormTemplate[]         @relation("FormTemplateJurisdiction")

  @@unique([stateCode, districtCode])
  @@index([stateCode])
}

// ============================================
// STATE MODEL (Reference Data)
// ============================================

model State {
  id           String    @id @default(cuid())
  code         String    @unique  // e.g., "MD", "VA", "DC"
  name         String              // e.g., "Maryland", "Virginia"
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  districts    District[]

  @@index([code])
  @@index([isActive])
}

// ============================================
// DISTRICT MODEL (Reference Data)
// ============================================

model District {
  id           String    @id @default(cuid())
  stateId      String
  name         String              // e.g., "Howard County Public School System"
  code         String              // e.g., "HCPSS"
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  state        State     @relation(fields: [stateId], references: [id])
  schools      School[]

  @@unique([stateId, code])
  @@index([stateId])
  @@index([isActive])
}

// ============================================
// SCHOOL MODEL (Reference Data)
// ============================================

enum SchoolType {
  ELEMENTARY
  MIDDLE
  HIGH
  K8
  K12
  OTHER
}

model School {
  id           String     @id @default(cuid())
  districtId   String?
  name         String              // e.g., "Wilde Lake High School"
  code         String?             // Optional school code
  stateCode    String?
  schoolType   SchoolType @default(OTHER)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  district     District?  @relation(fields: [districtId], references: [id])
  students     Student[]

  @@index([districtId])
  @@index([isActive])
}

// ============================================
// STUDENT MODEL
// ============================================

model Student {
  id            String    @id @default(uuid())
  recordId      String    @unique  // System-generated ID (e.g., "STU-000123")
  externalId    String?             // External SIS ID if used
  firstName     String
  lastName      String
  dateOfBirth   DateTime?
  grade         String?
  schoolName    String?             // Legacy field for backwards compatibility
  districtName  String?             // Legacy field for backwards compatibility
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  jurisdictionId String
  jurisdiction   Jurisdiction    @relation(fields: [jurisdictionId], references: [id])
  teacherId      String
  teacher        AppUser         @relation("TeacherStudents", fields: [teacherId], references: [id])
  schoolId       String?
  school         School?         @relation(fields: [schoolId], references: [id])
  statuses       StudentStatus[]
  planInstances  PlanInstance[]
  priorPlanDocuments PriorPlanDocument[]
  accessGrants   StudentAccess[]
  artifactComparisons ArtifactComparison[]

  @@index([recordId])
  @@index([externalId])
  @@index([lastName, firstName])
  @@index([teacherId])
  @@index([schoolId])
  studentFieldValues  StudentFieldValue[]
  iepReviews          IEPIndependentAssessmentReview[]
}

// ============================================
// STUDENT STATUS MODEL
// ============================================

model StudentStatus {
  id            String      @id @default(uuid())
  scope         StatusScope
  code          StatusCode
  summary       String?
  effectiveDate DateTime
  createdAt     DateTime    @default(now())

  // Relations
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  updatedById String
  updatedBy   AppUser  @relation("StatusUpdatedBy", fields: [updatedById], references: [id])

  @@index([studentId, scope])
  @@index([studentId, effectiveDate])
}

// ============================================
// PLAN TYPE MODEL
// ============================================

model PlanType {
  id          String       @id @default(uuid())
  code        PlanTypeCode
  name        String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  jurisdictionId String
  jurisdiction   Jurisdiction   @relation(fields: [jurisdictionId], references: [id])
  schemas        PlanSchema[]
  instances      PlanInstance[]
  priorPlanDocuments PriorPlanDocument[]
  bestPracticeDocs   BestPracticeDocument[] @relation("BestPracticeDocs")
  formTemplates      FormTemplate[]         @relation("FormTemplates")
  artifactComparisons ArtifactComparison[]

  @@unique([jurisdictionId, code])
  @@index([code])
}

// ============================================
// PLAN SCHEMA MODEL (Template for Plans)
// ============================================

model PlanSchema {
  id           String   @id @default(uuid())
  version      Int      @default(1)
  name         String
  description  String?
  fields       Json     // Array of field definitions
  isActive     Boolean  @default(true)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  planTypeId     String
  planType       PlanType          @relation(fields: [planTypeId], references: [id])
  jurisdictionId String?
  jurisdiction   Jurisdiction?     @relation("PlanSchemaJurisdiction", fields: [jurisdictionId], references: [id])
  instances      PlanInstance[]
  fieldConfigs   PlanFieldConfig[]

  @@index([planTypeId, isActive])
}

// ============================================
// PLAN FIELD CONFIG MODEL (Field Requirement Overrides)
// ============================================

model PlanFieldConfig {
  id           String     @id @default(cuid())
  planSchema   PlanSchema @relation(fields: [planSchemaId], references: [id], onDelete: Cascade)
  planSchemaId String

  sectionKey   String     // References section.key in schema
  fieldKey     String     // References field.key in schema

  // If null, use required flag from schemaJson
  isRequired   Boolean?

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([planSchemaId, sectionKey, fieldKey])
  @@index([planSchemaId])
}

// ============================================
// PLAN INSTANCE MODEL (Actual Student Plans)
// ============================================

model PlanInstance {
  id            String    @id @default(uuid())
  startDate     DateTime
  endDate       DateTime?
  status        String    @default("DRAFT") // DRAFT, ACTIVE, EXPIRED, SUPERSEDED
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  studentId    String
  student      Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  planTypeId   String
  planType     PlanType        @relation(fields: [planTypeId], references: [id])
  schemaId     String
  schema       PlanSchema      @relation(fields: [schemaId], references: [id])
  fieldValues  PlanFieldValue[]
  goals        Goal[]
  serviceLogs  ServiceLog[]
  behaviorPlan BehaviorPlan?
  artifactComparisons ArtifactComparison[]
  iepReviews   IEPIndependentAssessmentReview[]

  @@index([studentId, planTypeId])
  @@index([status])
}

// ============================================
// PLAN FIELD VALUE MODEL (Data for Each Plan Field)
// ============================================

model PlanFieldValue {
  id         String   @id @default(uuid())
  fieldKey   String   // References field key in PlanSchema.fields
  value      Json     // Flexible value storage
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  planInstanceId String
  planInstance   PlanInstance @relation(fields: [planInstanceId], references: [id], onDelete: Cascade)

  @@unique([planInstanceId, fieldKey])
  @@index([planInstanceId])
}

// ============================================
// GOAL MODEL (IEP Goals)
// ============================================

model Goal {
  id                  String            @id @default(uuid())
  planInstanceId      String
  goalCode            String
  area                GoalArea
  annualGoalText      String            @db.Text
  shortTermObjectives Json?
  baselineJson        Json?
  baselineValue       Float?
  targetValue         Float?
  presentLevelJson    Json?
  draftStatus         String?
  comarAlignmentJson  Json?
  progressSchedule    String            @default("WEEKLY")
  targetDate          DateTime
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  planInstance        PlanInstance      @relation(fields: [planInstanceId], references: [id])
  progressRecords     GoalProgress[]
  objectives          GoalObjective[]
  workSamples         WorkSample[]
  artifactLinks       GoalArtifactLink[]

  @@index([planInstanceId])
}

// ============================================
// GOAL PROGRESS MODEL (Progress Tracking)
// ============================================

model GoalProgress {
  id           String        @id @default(uuid())
  date         DateTime      @default(now())
  quickSelect  ProgressLevel // One-tap progress level
  measureJson  Json?         // Detailed measurement data
  percentCorrect Float?
  trials       String?
  notes        String?       @db.Text
  comment      String?       @db.Text
  isDictated   Boolean       @default(false) // True if entered via voice
  createdAt    DateTime      @default(now())

  // Relations
  goalId     String
  goal       Goal    @relation(fields: [goalId], references: [id], onDelete: Cascade)
  recordedById String
  recordedBy   AppUser @relation("ProgressRecordedBy", fields: [recordedById], references: [id])

  @@index([goalId, date])
  @@index([goalId])
}

// ============================================
// WORK SAMPLE MODEL (Student Work Samples)
// ============================================

model WorkSample {
  id         String           @id @default(uuid())
  fileUrl    String           // URL to stored file (S3, GCP, Azure)
  fileName   String
  fileType   String           // MIME type
  fileSize   Int              // Size in bytes
  rating     WorkSampleRating
  comment    String?
  capturedAt DateTime         @default(now())
  createdAt  DateTime         @default(now())

  // Relations
  goalId     String
  goal       Goal    @relation(fields: [goalId], references: [id], onDelete: Cascade)
  uploadedById String
  uploadedBy   AppUser @relation("WorkSampleUploadedBy", fields: [uploadedById], references: [id])

  @@index([goalId])
  @@index([capturedAt])
}

// ============================================
// SERVICE LOG MODEL (Service Delivery Tracking)
// ============================================

model ServiceLog {
  id          String        @id @default(uuid())
  date        DateTime
  minutes     Int
  serviceType ServiceType
  setting     ServiceSetting
  notes       String?       @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  planInstanceId String
  planInstance   PlanInstance @relation(fields: [planInstanceId], references: [id], onDelete: Cascade)
  providerId     String
  provider       AppUser      @relation("ServiceProvider", fields: [providerId], references: [id])

  @@index([planInstanceId, date])
  @@index([planInstanceId, serviceType])
  @@index([providerId])
}

// ============================================
// PRIOR PLAN DOCUMENT MODEL (Uploaded Prior Plans)
// ============================================

model PriorPlanDocument {
  id           String          @id @default(uuid())
  fileName     String
  storageKey   String          // Path or key in storage (local/S3)
  planDate     DateTime?       // Date of the prior plan (optional)
  source       PriorPlanSource @default(UPLOADED)
  notes        String?         @db.Text
  createdAt    DateTime        @default(now())

  // Relations
  studentId    String
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  planTypeId   String
  planType     PlanType @relation(fields: [planTypeId], references: [id])
  uploadedById String
  uploadedBy   AppUser  @relation("PriorPlanUploadedBy", fields: [uploadedById], references: [id])

  @@index([studentId])
  @@index([studentId, planTypeId])
  @@index([uploadedById])
}

// ============================================
// BEST PRACTICE DOCUMENT MODEL (Example IEPs, 504s, etc.)
// ============================================

model BestPracticeDocument {
  id               String          @id @default(uuid())
  title            String
  description      String?         @db.Text
  fileUrl          String          // Storage path or URL
  gradeBand        String?         // e.g., "K-2", "3-5", "6-8", "9-12"
  isActive         Boolean         @default(true)
  ingestionStatus  IngestionStatus @default(PENDING)
  ingestionMessage String?         // Error message if ingestion failed
  ingestionAt      DateTime?       // Last ingestion timestamp
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  planTypeId     String
  planType       PlanType      @relation("BestPracticeDocs", fields: [planTypeId], references: [id])
  jurisdictionId String?
  jurisdiction   Jurisdiction? @relation("BestPracticeJurisdiction", fields: [jurisdictionId], references: [id])
  uploadedById   String
  uploadedBy     AppUser       @relation("BestPracticeUploadedBy", fields: [uploadedById], references: [id])
  chunks         BestPracticeChunk[]

  @@index([planTypeId])
  @@index([jurisdictionId])
  @@index([isActive])
  @@index([ingestionStatus])
}

// ============================================
// FORM TEMPLATE MODEL (Blank printable forms)
// ============================================

model FormTemplate {
  id             String    @id @default(uuid())
  title          String
  description    String?   @db.Text
  fileUrl        String    // Storage path or URL
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  planTypeId     String
  planType       PlanType      @relation("FormTemplates", fields: [planTypeId], references: [id])
  jurisdictionId String?
  jurisdiction   Jurisdiction? @relation("FormTemplateJurisdiction", fields: [jurisdictionId], references: [id])
  uploadedById   String
  uploadedBy     AppUser       @relation("FormTemplateUploadedBy", fields: [uploadedById], references: [id])

  @@index([planTypeId])
  @@index([jurisdictionId])
  @@index([planTypeId, jurisdictionId, isDefault])
}

// ============================================
// BEST PRACTICE CHUNK MODEL (Extracted text for content generation)
// ============================================

model BestPracticeChunk {
  id                     String    @id @default(uuid())
  sequence               Int       // Order within the document
  sectionTag             String?   // e.g., "goals_reading", "accommodations", "present_levels"
  text                   String    @db.Text
  embedding              Bytes?    // Optional vector embedding for semantic search
  createdAt              DateTime  @default(now())

  // Denormalized fields for efficient querying
  planTypeCode           String    // IEP, FIVE_OH_FOUR, BEHAVIOR_PLAN
  jurisdictionId         String?
  gradeBand              String?

  // Relations
  bestPracticeDocumentId String
  document               BestPracticeDocument @relation(fields: [bestPracticeDocumentId], references: [id], onDelete: Cascade)

  @@index([bestPracticeDocumentId])
  @@index([planTypeCode, jurisdictionId, gradeBand, sectionTag])
  @@index([sectionTag])
}

// ============================================
// BEHAVIOR PLAN MODEL (Behavior Intervention Plans)
// ============================================

model BehaviorPlan {
  id             String   @id @default(uuid())
  planInstanceId String   @unique
  summary        String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  planInstance PlanInstance     @relation(fields: [planInstanceId], references: [id], onDelete: Cascade)
  targets      BehaviorTarget[]
}

// ============================================
// BEHAVIOR TARGET MODEL (Target Behaviors)
// ============================================

model BehaviorTarget {
  id              String                  @id @default(uuid())
  code            String                  // e.g., "BT-1", "BT-2"
  name            String                  // Short name for the behavior
  definition      String    @db.Text      // Operational definition
  examples        String?   @db.Text      // Examples of the behavior
  nonExamples     String?   @db.Text      // Non-examples (what it is not)
  measurementType BehaviorMeasurementType
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  behaviorPlanId String
  behaviorPlan   BehaviorPlan    @relation(fields: [behaviorPlanId], references: [id], onDelete: Cascade)
  events         BehaviorEvent[]

  @@unique([behaviorPlanId, code])
  @@index([behaviorPlanId])
}

// ============================================
// BEHAVIOR EVENT MODEL (Behavior Occurrences)
// ============================================

model BehaviorEvent {
  id               String    @id @default(uuid())
  eventDate        DateTime
  startTime        DateTime?
  endTime          DateTime?
  count            Int?              // For frequency measurement
  rating           Int?              // For rating measurement (1-5 scale)
  durationSeconds  Int?              // For duration measurement
  contextJson      Json?             // Antecedent, setting, notes
  createdAt        DateTime  @default(now())

  // Relations
  behaviorTargetId String
  target           BehaviorTarget @relation(fields: [behaviorTargetId], references: [id], onDelete: Cascade)
  recordedById     String
  recordedBy       AppUser        @relation("BehaviorRecordedBy", fields: [recordedById], references: [id])

  @@index([behaviorTargetId, eventDate])
  @@index([behaviorTargetId])
}

// ============================================
// USER PERMISSION MODEL (Fine-grained permissions)
// ============================================

model UserPermission {
  id             String   @id @default(uuid())
  userId         String   @unique
  canCreatePlans Boolean  @default(false) // Can create new 504/IEP/Behavior plans
  canUpdatePlans Boolean  @default(false) // Can edit plans, add targets, events
  canReadAll     Boolean  @default(false) // Can read all students in jurisdiction
  canManageUsers Boolean  @default(false) // Admin: can manage users and permissions
  canManageDocs  Boolean  @default(false) // Admin: can manage schemas, best practices
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// STUDENT ACCESS MODEL (Explicit student access grants)
// ============================================

model StudentAccess {
  id        String   @id @default(uuid())
  userId    String
  studentId String
  canEdit   Boolean   @default(false)
  createdAt DateTime  @default(now())
  grantedAt DateTime  @default(now())
  expiresAt DateTime? // Optional expiration

  // Relations
  user    AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([userId, studentId])
  @@index([userId])
  @@index([studentId])
}

// ============================================
// ARTIFACT COMPARISON MODEL (Artifact Compare Feature)
// ============================================

model ArtifactComparison {
  id               String   @id @default(uuid())
  planInstanceId   String
  studentId        String
  planTypeId       String

  artifactDate     DateTime
  description      String?  @db.Text

  baselineFileUrl  String
  compareFileUrl   String

  analysisText     String?  @db.Text

  createdById      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  planInstance     PlanInstance @relation(fields: [planInstanceId], references: [id], onDelete: Cascade)
  student          Student      @relation(fields: [studentId], references: [id])
  planType         PlanType     @relation(fields: [planTypeId], references: [id])
  createdBy        AppUser      @relation("ArtifactComparisonCreatedBy", fields: [createdById], references: [id])
  goalArtifactLinks GoalArtifactLink[]

  @@index([planInstanceId])
  @@index([studentId])
}

// ============================================
// SESSION MODEL (For connect-pg-simple)
// ============================================

model Session {
  sid    String   @id @db.VarChar(255)
  sess   Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], name: "IDX_session_expire")
  @@map("session")
}

// ============================================
// FORM FIELD ENUMS (Added for formFields feature)
// ============================================

enum FormType {
  IEP
  IEP_REPORT
  FIVE_OH_FOUR
  BIP
}

enum ControlType {
  TEXT
  TEXTAREA
  DROPDOWN
  RADIO
  CHECKBOX
  CHECKBOX_GROUP
  DATE
  SIGNATURE
}

enum OptionsEditableBy {
  ADMIN_ONLY
  TEACHER_ALLOWED
  NONE
}

enum AssessmentType {
  INITIAL
  REEVALUATION
  TRIENNIAL
  INDEPENDENT
}

// ============================================
// FORM FIELD DEFINITION MODEL
// ============================================

model FormFieldDefinition {
  id                String            @id @default(uuid())
  formType          FormType
  fieldKey          String
  fieldLabel        String
  section           String
  sectionOrder      Int               @default(0)
  controlType       ControlType
  placeholder       String?
  helpText          String?
  isRequired        Boolean           @default(false)
  isGoalsSection    Boolean           @default(false)
  sortOrder         Int               @default(0)
  valueEditableBy   String[]          @default(["ADMIN", "TEACHER", "CASE_MANAGER"])
  optionsEditableBy OptionsEditableBy @default(NONE)
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  options           FormFieldOption[]

  @@unique([formType, fieldKey])
}

// ============================================
// FORM FIELD OPTION MODEL
// ============================================

model FormFieldOption {
  id                    String              @id @default(uuid())
  formFieldDefinitionId String?
  value                 String
  label                 String
  sortOrder             Int                 @default(0)
  isActive              Boolean             @default(true)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  fieldDefinition       FormFieldDefinition? @relation(fields: [formFieldDefinitionId], references: [id], onDelete: Cascade)

  @@index([formFieldDefinitionId])
}

// ============================================
// STUDENT FIELD VALUE MODEL
// ============================================

model StudentFieldValue {
  id              String    @id @default(uuid())
  studentId       String
  fieldKey        String
  value           Json?
  createdById     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  student         Student   @relation(fields: [studentId], references: [id])
  createdBy       AppUser?  @relation("StudentFieldValueCreator", fields: [createdById], references: [id])

  @@unique([studentId, fieldKey])
  @@index([studentId])
}

// ============================================
// GOAL ARTIFACT LINK MODEL
// ============================================

model GoalArtifactLink {
  id                    String              @id @default(uuid())
  goalId                String
  artifactComparisonId  String
  linkType              String              @default("EVIDENCE")
  relevanceNote         String?             @db.Text
  notes                 String              @default("")
  linkedAt              DateTime            @default(now())
  createdAt             DateTime            @default(now())

  goal                  Goal                @relation(fields: [goalId], references: [id])
  artifactComparison    ArtifactComparison  @relation(fields: [artifactComparisonId], references: [id])

  @@index([goalId])
  @@index([artifactComparisonId])
}

// ============================================
// GOAL OBJECTIVE MODEL
// ============================================

model GoalObjective {
  id                  String    @id @default(uuid())
  goalId              String
  sequence            Int       @default(0)
  objectiveText       String    @db.Text
  measurementCriteria String?   @db.Text
  targetDate          DateTime?
  sortOrder           Int       @default(0)
  isCompleted         Boolean   @default(false)
  completedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  goal                Goal      @relation(fields: [goalId], references: [id])

  @@index([goalId])
}

// ============================================
// IEP INDEPENDENT ASSESSMENT REVIEW MODEL
// ============================================

model IEPIndependentAssessmentReview {
  id                  String          @id @default(uuid())
  studentId           String
  planInstanceId      String
  assessmentType      AssessmentType
  assessmentTypeOther String?
  assessmentDate      DateTime?
  dateOfReport        DateTime?
  dateOfTeamReview    DateTime?
  evaluator           String?
  school              String?
  grade               String?
  summary             String          @default("") @db.Text
  recommendations     String          @default("") @db.Text
  attachmentUrl       String          @default("")
  createdById         String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  student             Student         @relation(fields: [studentId], references: [id])
  planInstance        PlanInstance    @relation(fields: [planInstanceId], references: [id])
  createdBy           AppUser?        @relation("AssessmentReviewCreator", fields: [createdById], references: [id])

  @@index([studentId])
  @@index([planInstanceId])
}

// ============================================
// AUTH CODE MODEL (For serverless OAuth token exchange)
// ============================================

model AuthCode {
  id        String   @id
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      AppUser  @relation("AuthCodeUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
}
